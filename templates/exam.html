<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <title>İmtahan Davam Edir</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <script defer src="//unpkg.com/mathlive"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

    <script>
      window.MathJax = {
        tex: { 
          inlineMath: [['$', '$'], ['\\(', '\\)']], 
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true,
          packages: {'[+]': ['color']}
        },
        startup: { 
          typeset: true,
          ready: function() {
            MathJax.startup.defaultReady();
            MathJax.startup.promise.then(function() {
              // Typeset again after everything is loaded
              setTimeout(function() {
                MathJax.typeset();
              }, 50);
            });
          }
        }
      };
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Animasiyalar */
        .fade-in { animation: fadeIn 0.6s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Quill Editor Customization */
        .ql-container { height: 220px; font-size: 16px; font-family: 'Inter', sans-serif; border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }
        .ql-toolbar { border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; background-color: #f9fafb; }
        
        /* Custom UI Elements */
        .badge { padding: 4px 12px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .badge-easy { background-color: #dcfce7; color: #166534; }
        .badge-medium { background-color: #fef9c3; color: #854d0e; }
        .badge-hard { background-color: #fee2e2; color: #991b1b; }

        math-field { font-size: 20px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; width: 100%; background: #fff; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        math-field:focus-within { border-color: #3b82f6; ring: 2px; }

        .tool-btn { display: flex; align-items: center; justify-content: center; gap: 6px; padding: 8px 16px; border-radius: 8px; font-size: 0.875rem; font-weight: 500; transition: all 0.2s; border: 1px solid #e2e8f0; background: white; color: #475569; }
        .tool-btn:hover { background: #f1f5f9; border-color: #cbd5e1; transform: translateY(-1px); }
        .active-tool { background: #eff6ff; color: #2563eb; border-color: #bfdbfe; }
        
        /* Modal Overlay */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 50; justify-content: center; align-items: center; animation: fadeIn 0.2s; }
    </style>
</head>
<body class="bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-5xl mx-auto">
        <div class="flex items-center justify-between mb-8 fade-in">
            <div>
                <h2 class="text-3xl font-bold text-slate-900 tracking-tight">Final İmtahanı</h2>
                <p class="text-slate-500 mt-1">Diqqətlə oxuyun və cavablandırın.</p>
            </div>
            <div class="hidden md:flex items-center gap-2 bg-white px-4 py-2 rounded-full shadow-sm border border-gray-200">
                <i class="ri-timer-line text-blue-600"></i>
                <span id="timer" class="text-sm font-medium text-gray-700">100:00</span>
            </div>
        </div>
        
        <form id="examForm" action="" method="POST" enctype="multipart/form-data" class="space-y-8">
            {% for q in questions %}
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden fade-in" style="animation-delay: {{ loop.index0 * 100 }}ms">
                <div class="px-6 py-5 border-b border-gray-50 flex justify-between items-center bg-gray-50/50">
                    <div class="flex items-center gap-3">
                        <span class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-600 text-white font-bold text-sm">
                            {{ loop.index }}
                        </span>
                        <span class="text-sm text-gray-500 font-medium">Sual</span>
                    </div>
                    <span class="badge 
                        {% if q.difficulty == 'Easy' %} badge-easy 
                        {% elif q.difficulty == 'Medium' %} badge-medium 
                        {% else %} badge-hard {% endif %}">
                        {{ q.difficulty }}
                    </span>
                </div>
                
                <div class="p-6 md:p-8">
                    <div class="text-lg text-slate-800 leading-relaxed font-medium mb-6">
                        {{ q.text | safe }}
                    </div>
                    
                    <div class="flex flex-wrap gap-3 mb-4">
                        <button type="button" onclick="openMathModal('editor-{{ q.id }}')" class="tool-btn text-indigo-600 border-indigo-100 hover:bg-indigo-50">
                            <i class="ri-functions-xy"></i> Düstur
                        </button>
                        <button type="button" onclick="openGraphicModal('editor-{{ q.id }}')" class="tool-btn text-purple-600 border-purple-100 hover:bg-purple-50">
                            <i class="ri-shape-line"></i> Qrafik / Sxem
                        </button>
                    </div>

                    <div class="shadow-sm rounded-lg">
                        <div id="editor-container-{{ q.id }}"></div>
                    </div>
                    <input type="hidden" name="question_id" value="{{ q.id }}">
                    <input type="hidden" name="answer_{{ q.id }}" id="input-{{ q.id }}">

                    <div class="mt-6">
                        <label class="flex items-center gap-2 text-sm text-gray-500 mb-2 cursor-pointer hover:text-blue-600 transition-colors w-max">
                            <i class="ri-attachment-line"></i> Kağız həlli yüklə (istəyə bağlı)
                        </label>
                        <input type="file" name="file_{{ q.id }}" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition-all"/>
                    </div>
                </div>
            </div>
            {% endfor %}
            
            <div class="sticky bottom-4 z-40">
                <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-xl text-lg font-bold hover:bg-slate-800 transition-all shadow-xl shadow-slate-900/20 transform hover:-translate-y-1 flex items-center justify-center gap-2">
                    <i class="ri-check-double-line"></i> İmtahanı Bitir
                </button>
            </div>
        </form>
    </div>

    <div id="mathModal" class="modal-overlay">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-xl mx-4 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i class="ri-calculator-line text-blue-600"></i> Riyazi Panel</h3>
                <button onclick="closeMathModal()" class="text-gray-400 hover:text-red-500 transition-colors"><i class="ri-close-circle-fill text-2xl"></i></button>
            </div>
            
            <math-field id="math-input" virtual-keyboard-mode="manual">f(x) = \int x dx</math-field>

            <div class="grid grid-cols-3 sm:grid-cols-6 gap-2 mt-4">
                <button onclick="insertTemplate('\\frac{a}{b}')" class="tool-btn">\(\frac{a}{b}\)</button>
                <button onclick="insertTemplate('\\sqrt{x}')" class="tool-btn">\(\sqrt{x}\)</button>
                <button onclick="insertTemplate('x^{2}')" class="tool-btn">\(x^2\)</button>
                <button onclick="insertTemplate('\\int_{a}^{b}')" class="tool-btn">\(\int\)</button>
                <button onclick="insertTemplate('\\sum')" class="tool-btn">\(\sum\)</button>
                <button onclick="insertTemplate('\\lim_{x \\to \\infty}')" class="tool-btn">\(\lim\)</button>
                <button onclick="insertTemplate('\\pi')" class="tool-btn">\(\pi\)</button>
                <button onclick="insertTemplate('\\infty')" class="tool-btn">\(\infty\)</button>
                <button onclick="insertTemplate('\\approx')" class="tool-btn">\(\approx\)</button>
                <button onclick="insertTemplate('\\le')" class="tool-btn">\(\le\)</button>
                <button onclick="insertTemplate('\\sqrt[3]{x}')" class="tool-btn">\(\sqrt[3]{x}\)</button>
                <button onclick="insertTemplate('\\sqrt[4]{x}')" class="tool-btn">\(\sqrt[4]{x}\)</button>
                <button onclick="insertTemplate('\\sqrt[n]{x}')" class="tool-btn">\(\sqrt[n]{x}\)</button>
                <button onclick="insertTemplate('\\sin')" class="tool-btn">\(\sin\)</button>
                <button onclick="insertTemplate('\\cos')" class="tool-btn">\(\cos\)</button>
                <button onclick="insertTemplate('\\tan')" class="tool-btn">\(\tan\)</button>
                <button onclick="insertTemplate('\\log')" class="tool-btn">\(\log\)</button>
                <button onclick="insertTemplate('\\ln')" class="tool-btn">\(\ln\)</button>
                <button onclick="insertTemplate('e^{x}')" class="tool-btn">\(e^{x}\)</button>
                <button onclick="insertTemplate('\\frac{d}{dx}')" class="tool-btn">\(\frac{d}{dx}\)</button>
                <button onclick="insertTemplate('\\alpha')" class="tool-btn">\(\alpha\)</button>
                <button onclick="insertTemplate('\\beta')" class="tool-btn">\(\beta\)</button>
                <button onclick="insertTemplate('\\gamma')" class="tool-btn">\(\gamma\)</button>
                <button onclick="insertTemplate('\\geq')" class="tool-btn">\(\geq\)</button>
                <button onclick="insertTemplate('\\leq')" class="tool-btn">\(\leq\)</button>
                <button onclick="insertTemplate('\\neq')" class="tool-btn">\(\neq\)</button>
                <button onclick="insertTemplate('\\in')" class="tool-btn">\(\in\)</button>
                <button onclick="insertTemplate('\\subset')" class="tool-btn">\(\subset\)</button>
                <button onclick="insertTemplate('\\pm')" class="tool-btn">\(\pm\)</button>
                <button onclick="insertTemplate('\\vec{x}')" class="tool-btn">\(\vec{x}\)</button>
                <button onclick="insertTemplate('|x|')" class="tool-btn">\( |x| \)</button>
                <button onclick="insertTemplate('\\lfloor x \\rfloor')" class="tool-btn">\(\lfloor x \rfloor\)</button>
                <button onclick="insertTemplate('\\lceil x \\rceil')" class="tool-btn">\(\lceil x \rceil\)</button>
                <button onclick="insertTemplate('\\to')" class="tool-btn">\(\to\)</button>
                <button onclick="insertTemplate('\\implies')" class="tool-btn">\(\implies\)</button>
                <button onclick="insertTemplate('\\forall')" class="tool-btn">\(\forall\)</button>
                <button onclick="insertTemplate('\\exists')" class="tool-btn">\(\exists\)</button>
                <button onclick="insertTemplate('\\partial')" class="tool-btn">\(\partial\)</button>
                <button onclick="insertTemplate('\\nabla')" class="tool-btn">\(\nabla\)</button>
                <button onclick="insertTemplate('\\therefore')" class="tool-btn">\(\therefore\)</button>
                <button onclick="insertTemplate('\\because')" class="tool-btn">\(\because\)</button>
                <button onclick="insertTemplate('\\dots')" class="tool-btn">\(\dots\)</button>
                <button onclick="insertTemplate('\\cdots')" class="tool-btn">\(\cdots\)</button>
            </div>

            <div class="mt-8 flex justify-end gap-3">
                <button onclick="closeMathModal()" class="px-5 py-2.5 rounded-xl text-slate-600 hover:bg-slate-100 font-medium transition-colors">Ləğv</button>
                <button onclick="saveMath()" class="px-5 py-2.5 rounded-xl bg-blue-600 text-white hover:bg-blue-700 font-medium shadow-lg shadow-blue-600/20 transition-all">Əlavə Et</button>
            </div>
        </div>
    </div>

    <div id="graphicModal" class="modal-overlay">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-4xl mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i class="ri-pencil-ruler-2-line text-purple-600"></i> Qrafik Qurucusu</h3>
                <button onclick="closeGraphicModal()" class="text-gray-400 hover:text-red-500"><i class="ri-close-circle-fill text-2xl"></i></button>
            </div>

            <div class="flex flex-wrap gap-2 mb-4 bg-slate-50 p-2 rounded-xl border border-slate-100">
                <button onclick="addGrid()" class="tool-btn"><i class="ri-grid-line"></i> Tor</button>
                <button onclick="addShape('triangle')" class="tool-btn"><i class="ri-triangle-line"></i> Üçbucaq</button>
                <button onclick="addShape('circle')" class="tool-btn"><i class="ri-circle-line"></i> Dairə</button>
                <button onclick="addText()" class="tool-btn"><i class="ri-text"></i> Yazı</button>
                <div class="w-px h-6 bg-gray-300 mx-1"></div>
                <button onclick="toggleDraw()" id="drawBtn" class="tool-btn"><i class="ri-pencil-line"></i> Qələm</button>
                <button onclick="deleteObject()" class="tool-btn text-red-600 border-red-100 hover:bg-red-50"><i class="ri-delete-bin-line"></i> Sil</button>
                <button onclick="clearGraphic()" class="tool-btn text-red-600 border-red-100 hover:bg-red-50"><i class="ri-eraser-line"></i> Təmizlə</button>
            </div>

            <div class="border border-slate-200 rounded-xl overflow-hidden bg-white">
                <canvas id="c" width="850" height="450"></canvas>
            </div>

            <div class="mt-6 flex justify-end gap-3">
                <button onclick="closeGraphicModal()" class="px-5 py-2.5 rounded-xl text-slate-600 hover:bg-slate-100 font-medium">Ləğv</button>
                <button onclick="saveGraphic()" class="px-5 py-2.5 rounded-xl bg-purple-600 text-white hover:bg-purple-700 font-medium shadow-lg shadow-purple-600/20">Əlavə Et</button>
            </div>
        </div>
    </div>

    <script>
        var editors = {};
        var currentEditorId = null;
        var mathField = document.getElementById('math-input');

        // Quill Init
        document.querySelectorAll('[id^="editor-container-"]').forEach(function(container) {
            var id = container.id.replace('editor-container-', '');
            var quill = new Quill(container, {
                modules: { toolbar: [['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['image']] },
                theme: 'snow',
                placeholder: 'Cavabınızı bura yazın...'
            });
            editors['editor-' + id] = quill;
            
            // Load saved content
            var savedContent = localStorage.getItem('exam_answer_' + id);
            if (savedContent) {
                quill.root.innerHTML = savedContent;
            }
            
            // Auto-save on change
            quill.on('text-change', function() {
                localStorage.setItem('exam_answer_' + id, quill.root.innerHTML);
            });
        });

        document.getElementById('examForm').onsubmit = function() {
            for (var key in editors) {
                var qId = key.replace('editor-', '');
                document.getElementById('input-' + qId).value = editors[key].root.innerHTML;
            }
            // Clear saved answers after submission
            for (var key in editors) {
                var qId = key.replace('editor-', '');
                localStorage.removeItem('exam_answer_' + qId);
            }
        };

        // Math Functions
        function openMathModal(editorId) {
            currentEditorId = editorId;
            document.getElementById('mathModal').style.display = 'flex';
            mathField.setValue(''); mathField.focus();
            if (typeof MathJax !== 'undefined') {
                MathJax.typeset(document.getElementById('mathModal'));
            }
        }
        function insertTemplate(latex) { mathField.executeCommand(['insert', latex]); mathField.focus(); }
        function saveMath() {
            var latex = mathField.getValue();
            var quill = editors[currentEditorId];
            var range = quill.getSelection(true);
            quill.insertText(range.index, ' $' + latex + '$ ', 'bold', true);
            closeMathModal();
            setTimeout(() => { if(window.MathJax) window.MathJax.typesetPromise(); }, 100);
        }
        function closeMathModal() { document.getElementById('mathModal').style.display = 'none'; }

        // Graphic Functions
        var canvas = new fabric.Canvas('c', { isDrawingMode: false });
        
        // Responsive Canvas
        function resizeCanvas() {
             // canvas.setWidth(document.querySelector('.modal-overlay .bg-white').clientWidth - 48); // Simple resize logic if needed
        }

        function openGraphicModal(editorId) {
            currentEditorId = editorId;
            document.getElementById('graphicModal').style.display = 'flex';
            canvas.clear(); canvas.setBackgroundColor('#fff', canvas.renderAll.bind(canvas));
        }
        function addGrid() {
            var gridGroup = []; var width = 850; var height = 450;
            for (var i = 0; i < (width/25); i++) gridGroup.push(new fabric.Line([ i*25, 0, i*25, height], { stroke: '#f1f5f9', selectable: false }));
            for (var i = 0; i < (height/25); i++) gridGroup.push(new fabric.Line([ 0, i*25, width, i*25], { stroke: '#f1f5f9', selectable: false }));
            gridGroup.push(new fabric.Line([width/2, 0, width/2, height], { stroke: '#94a3b8', strokeWidth: 1, selectable: false }));
            gridGroup.push(new fabric.Line([0, height/2, width, height/2], { stroke: '#94a3b8', strokeWidth: 1, selectable: false }));
            var group = new fabric.Group(gridGroup, { left: 0, top: 0, selectable: false, evented: false });
            canvas.add(group); canvas.sendToBack(group);
        }
        function addShape(type) {
            if(type==='triangle') canvas.add(new fabric.Triangle({ width: 80, height: 80, fill: 'transparent', stroke: '#2563eb', strokeWidth: 3, left: 100, top: 100 }));
            if(type==='circle') canvas.add(new fabric.Circle({ radius: 40, fill: 'transparent', stroke: '#ef4444', strokeWidth: 3, left: 200, top: 100 }));
        }
        function addText() { canvas.add(new fabric.IText('Mətn...', { left: 100, top: 200, fontSize: 18, fill: '#1e293b', fontFamily: 'Inter' })); }
        function toggleDraw() {
            canvas.isDrawingMode = !canvas.isDrawingMode;
            document.getElementById('drawBtn').classList.toggle('active-tool');
            canvas.freeDrawingBrush.width = 3; canvas.freeDrawingBrush.color = "#1e293b";
        }
        function deleteObject() { var ao = canvas.getActiveObjects(); if(ao.length) { canvas.discardActiveObject(); ao.forEach(o => canvas.remove(o)); } }
        function clearGraphic() { canvas.clear(); canvas.setBackgroundColor('#fff', canvas.renderAll.bind(canvas)); }
        function saveGraphic() {
            var d = canvas.toDataURL({ format: 'png', quality: 1 });
            var q = editors[currentEditorId];
            var r = q.getSelection(true);
            q.insertEmbed(r.index, 'image', d);
            closeGraphicModal();
        }
        function closeGraphicModal() { document.getElementById('graphicModal').style.display = 'none'; }

        // Timer functionality
        let totalTime = 100 * 60; // 100 minutes in seconds
        const timerElement = document.getElementById('timer');
        function updateTimer() {
            const minutes = Math.floor(totalTime / 60);
            const seconds = totalTime % 60;
            timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            if (totalTime < 600) { // Less than 10 minutes
                timerElement.style.color = 'red';
            }
            if (totalTime <= 0) {
                clearInterval(timerInterval);
                alert('Vaxt bitdi! İmtahan avtomatik olaraq təqdim olunacaq.');
                document.getElementById('examForm').submit();
            } else {
                totalTime--;
            }
        }
        const timerInterval = setInterval(updateTimer, 1000);
    </script>
    <script>
        // Ensure MathJax is loaded before typesetting
        function typesetMathJax() {
            if (window.MathJax && MathJax.typeset) {
                MathJax.typeset();
            }
        }
        
        // Typeset immediately
        typesetMathJax();
        
        // Typeset after DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(typesetMathJax, 100);
        });
        
        // Typeset after window loads
        window.addEventListener('load', function() {
            setTimeout(typesetMathJax, 200);
        });
    </script>
</body>
</html>